<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yameokja.mc.IstDetailDAO_userView">
 	
 	<!-- 영업시간 가지고 오는 쿼리문 -->
 	<select id="openClose" resultType="com.yameokja.mc.stDetailDTO_userView">
	 	SELECT SL.ST_NUM AS ST_NUM, OC.DAY_NUM AS DAY_NUM, WDL.DAY_NAME AS DAY_NAME
			, OC.START_TIME AS START_TIME, OC.END_TIME AS END_TIME
		FROM ST_OPENCLOSE OC
		JOIN ST_LIST SL ON OC.ST_NUM = SL.ST_NUM
		JOIN WEEKDAY_LABEL WDL ON OC.DAY_NUM = WDL.DAY_NUM
		WHERE SL.ST_NUM = 1
		ORDER BY DAY_NUM
 	</select>
 	
 	
 	<!-- 브레이크 타임 따로 -->
 	<select id="breakTime" resultType="com.yameokja.mc.stDetailDTO_userView">
 		SELECT WWL.WEEK_WEEKEND AS WEEK_WEEKEND
			, BT.START_BREAKTIME AS START_BREAKTIME
			, BT.END_BREAKTIME AS END_BREAKTIME
		FROM ST_LIST SL
		JOIN BREAKTIME BT ON SL.ST_NUM = BT.ST_NUM
		JOIN WEEK_WEEKEND_LABEL WWL ON BT.WEEK_WEEKEND_NUM = WWL.WEEK_WEEKEND_NUM
		WHERE SL.ST_NUM = 1
 	</select>
 	
 	
 	<!-- 휴일 가지고 오는 쿼리문 -->
 	<select id="holiday" resultType="com.yameokja.mc.stDetailDTO_userView">
 		SELECT WDL.DAY_NAME AS DAY_NAME
		FROM ST_HOLIDAY SH
		JOIN ST_LIST SL ON SH.ST_NUM = SL.ST_NUM
		JOIN WEEKDAY_LABEL WDL ON SH.DAY_NUM = WDL.DAY_NUM
		WHERE SL.ST_NUM = 1
        ORDER BY WDL.DAY_NUM
 	</select>
 	
 	
 	<!-- 가게이름, 좋아요 수, 별점 평균, 리뷰 수, 전화번호, 주소 합침 -->
 	<select id="store" resultType="com.yameokja.mc.stDetailDTO_userView">
	SELECT IA.ST_NAME AS ST_NAME
    , NVL(COUNT(LIKE_BOX.LIKE_NUM), 0) AS LIKE_COUNT
    , NVL(ROUND(AVG(STAR_SCORE), 2), 0) AS STAR_SCORE
    , NVL(COUNT(RV_BOX.RV_NUM), 0) AS REVIEW_COUNT
    , IA.ST_TEL, IA.ST_LOCATION
	FROM ST_LIST SL
	LEFT JOIN IN_PROCESS IP ON SL.IN_PROCESS_NUM = IP.IN_PROCESS_NUM
	LEFT JOIN IN_APPLY IA ON IP.IN_APPLY_NUM = IA.IN_APPLY_NUM 
	LEFT JOIN LIKE_BOX ON SL.ST_NUM = LIKE_BOX.ST_NUM
	LEFT JOIN RV_BOX ON SL.ST_NUM = RV_BOX.ST_NUM
	WHERE SL.ST_NUM = 1
	GROUP BY IA.ST_NAME, IA.ST_TEL, IA.ST_LOCATION
	</select>
 	
 	<select id="stName"  resultType="com.yameokja.mc.stDetailDTO_userView">
 		SELECT IA.ST_NAME AS ST_NAME
		FROM IN_APPLY IA
		JOIN IN_PROCESS IP ON IA.IN_APPLY_NUM = IP.IN_APPLY_NUM
		JOIN ST_LIST SL ON IP.IN_PROCESS_NUM = SL.IN_PROCESS_NUM
		WHERE SL.ST_NUM = 1
 	</select>
 	
 	
 	<select id="clikeNum" resultType="java.lang.Integer"> <!-- 좋아요 수 -->
 		SELECT NVL(COUNT(LIKE_BOX.LIKE_NUM), 0) AS LIKE_COUNT
		FROM ST_LIST
		LEFT JOIN LIKE_BOX 
		ON ST_LIST.ST_NUM = LIKE_BOX.ST_NUM
		WHERE ST_LIST.ST_NUM = 1
 	</select>
 	
 	
 	<select id="creviewScore" resultType="java.lang.Double"> <!-- 별점 평균 -->
 		SELECT NVL(ROUND(AVG(STAR_SCORE), 2), 0) AS STAR_SCORE
		FROM ST_LIST
		LEFT JOIN RV_BOX 
		ON ST_LIST.ST_NUM = RV_BOX.ST_NUM
		WHERE ST_LIST.ST_NUM = 1
 	</select>
 	
 	<select id="creviewNum" resultType="java.lang.Integer"> <!-- 리뷰 수 -->
 		SELECT NVL(COUNT(RV_BOX.RV_NUM), 0) AS REVIEW_COUNT
		FROM ST_LIST
		LEFT JOIN  RV_BOX
		ON ST_LIST.ST_NUM = RV_BOX.ST_NUM
		WHERE ST_LIST.ST_NUM = 1
 	</select>
 	
 	<select id="tel" resultType="com.yameokja.mc.stDetailDTO_userView"> <!-- 전화번호 -->
 		SELECT ST_TEL
 		FROM IN_APPLY
		LEFT JOIN IN_PROCESS
		ON IN_APPLY.IN_APPLY_NUM = IN_PROCESS.IN_APPLY_NUM
		LEFT JOIN ST_LIST
		ON IN_PROCESS.IN_PROCESS_NUM = ST_LIST.IN_PROCESS_NUM
		WHERE ST_LIST.ST_NUM = 1
 	</select>
 	
 	<select id="lo" resultType="com.yameokja.mc.stDetailDTO_userView"> <!-- 주소 -->
 		SELECT ST_LOCATION
 		FROM IN_APPLY
		LEFT JOIN IN_PROCESS
		ON IN_APPLY.IN_APPLY_NUM = IN_PROCESS.IN_APPLY_NUM
		LEFT JOIN ST_LIST
		ON IN_PROCESS.IN_PROCESS_NUM = ST_LIST.IN_PROCESS_NUM
		WHERE ST_LIST.ST_NUM = 1
 	</select>
 	
 	<!-- 기타사항 / 결제수단, 설명, 이메일, 가게 최대 인원수 -->
 	<select id="others" resultType="com.yameokja.mc.stDetailDTO_userView">
 		<!-- CREATE OR REPLACE VIEW STORE_VIEW
		AS-->
		SELECT  SL.ST_EXPLAIN AS ST_EXPLAIN
	    , SL.MAX_CUSTOMERS AS MAX_CUSTOMERS, NVL(SL.ST_EMAIL, ' ') AS ST_EMAIL
	    , SL.ST_NUM AS ST_NUM
	    , NVL(PL.PAY_NAME, '결제는 카운터에 문의') AS PAY_NAME
	    FROM IN_PROCESS IP 
	    LEFT JOIN IN_APPLY IA
	    ON IP.IN_APPLY_NUM = IA.IN_APPLY_NUM
	    RIGHT JOIN ST_LIST SL
	    ON SL.IN_PROCESS_NUM = IP.IN_PROCESS_NUM
	    LEFT JOIN ST_PAY SP
	    ON SL.ST_NUM = SP.ST_NUM
	    LEFT JOIN PAY_LABEL PL
	    ON SP.PAY_NUM = PL.PAY_NUM
	    WHERE SL.STATEMENT_NUM = 1 AND SL.ST_NUM = 1
 	</select>
 	
 	
 	<!-- 메뉴 및 가격 가져오기-->
 	<select id="menuLists" resultType="com.yameokja.mc.stDetailDTO_userView">
 		SELECT MENU_NAME, PRICE, IMAGE_LINK
		FROM MENU
		LEFT JOIN ST_LIST SL ON SL.ST_NUM = MENU.ST_NUM
		WHERE SL.ST_NUM = 1
 	</select>
 	
 	
 	<!-- 가게 키워드 -->
 	<select id="stKeys" resultType="com.yameokja.mc.stDetailDTO_userView">
 		SELECT SKL.ST_KEYWORD AS ST_KEYWORD
 		FROM ST_KEY_LABEL SKL
 		LEFT JOIN ST_KEY SK ON SK.ST_KEY_NUM = SKL.ST_KEY_NUM
 		LEFT JOIN ST_LIST SL ON SL.ST_NUM = SK.ST_KEY_NUM
 		WHERE SL.ST_NUM = 1
 	</select>
 	
 	<!-- 리뷰 가져오기 -->
 	<select id="reViews" resultType="com.yameokja.mc.stDetailDTO_userView">
 		SELECT UU.USER_NICKNAME AS USER_NICKNAME, RV.RV_CONTENT AS RV_CONTENT
		, RV.STAR_SCORE AS STAR_SCORE, RV.REG_DATE AS REG_DATE
		, (SELECT NVL(COUNT(REC_NONREC_NUMBER), 0) FROM REC_NONREC
        WHERE REC_NONREC_NUMBER=1) AS REC_NONREC_NAME1 
        , (SELECT NVL(COUNT(REC_NONREC_NUMBER), 0) FROM REC_NONREC
        WHERE REC_NONREC_NUMBER=2) AS REC_NONREC_NAME2 
 		FROM RV_BOX RV
 		LEFT JOIN RV_REC_NONREC RRN ON RV.RV_NUM = RRN.RV_NUM
 		RIGHT JOIN USING_USER UU ON UU.USER_NUM = RV.USER_NUM
		WHERE RRN.REC_NONREC_NUMBER IS NOT NULL AND RV.ST_NUM = 1
 	</select>
 	
 
</mapper>