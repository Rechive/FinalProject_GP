<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.yameokja.mc.IStoreMainDAO">
	<select id="searchStoreInfo" resultType="com.yameokja.mc.StoreDTO">
		SELECT ST_NUM, ST_NAME
		FROM STORE_VIEW
		WHERE USER_NUM = #{user_num}
		ORDER BY REG_DATE DESC
	</select>
	
	<select id="searchRepStore" resultType="java.lang.Integer">
		SELECT ST_NUM
		FROM REP_STORE
		WHERE USER_NUM = #{user_num}
	</select>
	
	<select id="star_transition" resultType="java.util.HashMap">
		SELECT TO_CHAR(TRUNC(REG_DATE, 'Q')) AS QUARTER_START_DATE, AVG(STAR_SCORE) AS AVERAGE_STAR_SCORE
		FROM RV_BOX
		WHERE ST_NUM = #{st.num}
		GROUP BY TRUNC(REG_DATE, 'Q')
		ORDER BY TRUNC(REG_DATE, 'Q')
	</select>
	
	<select id="rv_key_sum" resultType="java.util.HashMap">
		SELECT COUNT(RK.CHOSEN_RV_KEY_NUM) AS COUNT_RV_KEY, RKL.RV_KEY_NAME AS RV_KEY_NAME
		FROM RV_KEY_LABEL RKL LEFT JOIN RV_KEY RK
		                   ON RKL.RV_KEY_NUM = RK.RV_KEY_NUM
		                   LEFT JOIN RV_BOX RB
		                       ON RK.RV_NUM = RB.RV_NUM
		WHERE RB.ST_NUM = #{st_num} OR RB.ST_NUM IS NULL
		GROUP BY RKL.RV_KEY_NAME, RB.ST_NUM
		ORDER BY COUNT(RK.CHOSEN_RV_KEY_NUM) DESC
	</select>
	
	<select id="rv_list" resultType="com.yameokja.mc.ReviewDTO">
		<!-- SELECT UU.USER_NICKNAME AS USER_NICKNAME, RB.RV_CONTENT AS RV_CONTENT, RB.REG_DATE AS REG_DATE, RB.RV_NUM AS RV_NUM
		FROM RV_BOX RB LEFT JOIN USING_USER UU
		ON RB.USER_NUM = UU.USER_NUM
		WHERE RB.ST_NUM = #{st_num}
		ORDER BY RV_NUM DESC -->
		SELECT UU.USER_NICKNAME AS USER_NICKNAME, RB.RV_CONTENT AS RV_CONTENT
		    , RB.REG_DATE AS REG_DATE, RB.RV_NUM AS RV_NUM
		    , RR.REPLY_CONTENT AS REPLY_CONTENT
		FROM RV_BOX RB 
		LEFT JOIN USING_USER UU ON RB.USER_NUM = UU.USER_NUM
		LEFT JOIN RV_REPLY RR ON RB.RV_NUM = RR.RV_NUM
		WHERE RB.ST_NUM = #{st_num}
		ORDER BY RV_NUM DESC
	</select>
	
	<!-- 리뷰 답글 insert -->
	<insert id="reviewReply">
		INSERT INTO RV_REPLY(REPLY_NUM, RV_NUM, REPLY_CONTENT, REG_DATE)
		VALUES(SELECT NVL(MAX(OUT_APPLY_NUM)+1,0) FROM RV_REPLY, #{user_num}, #{reply_content},SYSDATE)
	</insert>

</mapper>





                           


